# MySQL半同步复制和lossless无损复制

## 异步复制
MySQL默认的复制是异步的，主库在执行完客户端提交的事务后，会立即将结果返回给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，如果主库crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，将从提升为主，可能导致新的主库上的数据不完整。

异步复制的优点：
+ 复制的性能最好

异步复制的缺点
+ master挂掉后，slave可能会丢失数据

## 全同步复制
全同步复制是指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能会受到非常大的影响。

+ 优点：
    - 数据不会丢失
+ 缺点：
    - 会阻塞master session，性能太差，非常依赖网络

## 传统的半同步复制
传统的半同步复制介于异步复制和全同步复制之间，主库执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写入relay log中才返回给客户端。
相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。
+ 优点
    - 会有数据丢失风险（低）
+ 缺点
    - 会阻塞master session，性能差，非常依赖网络

由于master是在三段提交的最后commit阶段完成后才等待，所以master的其他session是可以看到这个提交事务的，所以这时候master上的数据和slave不一致，master crash后，slave数据丢失

## 增强版的半同步复制（无损复制 lossless replication）
在半同步复制中，master写数据到binlog且sync，然后一直等待slave的ACK，当至少一个slave请求binlog后且写入到relay log中并flush disk，就返回ack（不需要回访完日志）
+ 优点
    - 数据领丢失（前提是让其一直是lossless replication）
    - 性能好
+ 缺点
    - 非常依赖网络
